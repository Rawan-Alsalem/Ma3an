<!-- backOffice/templates/backOffice/manage_subscriptions.html -->
{% extends 'backOffice/base.html' %}
{% block title %}Manage Subscriptions{% endblock %}

{% block content %}

<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
  <div>
    <div class="page-title h3 mb-1">Manage Subscriptions</div>
    <div class="text-muted">Edit and renew agency subscriptions</div>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-center">
      <div class="col-12 col-lg-8">
        <div class="input-group">
          <span class="input-group-text bg-transparent border-secondary text-muted"><i class="bi bi-search"></i></span>
          <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Search agency, owner, email, plan">
        </div>
      </div>
      <div class="col-12 col-lg-4 d-flex gap-2">
        <button class="btn btn-primary w-100" type="submit"><i class="bi bi-search me-1"></i> Search</button>
        <a class="btn btn-outline-light w-100" href="{% url 'backOffice:manage_subscriptions' %}">Reset</a>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    {% if subs %}
      <div class="table-responsive">
        <table class="table align-middle table-hover mb-0">
          <thead>
            <tr>
              <th>Agency</th>
              <th>Plan</th>
              <th>Status</th>
              <th>Expires</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for s in subs %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ s.agency.agency_name }}</div>
                  <div class="text-muted small">{{ s.agency.user.username }} Â· {{ s.agency.user.email }}</div>
                </td>
                <td>
                  <span class="badge badge-soft">{{ s.plan.subscriptionType }}</span>
                </td>
                <td>
                  {% if s.status == 'active' %}
                    <span class="badge bg-success">Active</span>
                  {% elif s.status == 'expired' %}
                    <span class="badge bg-secondary">Expired</span>
                  {% else %}
                    <span class="badge bg-danger">Canceled</span>
                  {% endif %}
                </td>
                <td>{{ s.expiry_date|default:"-" }}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-light" href="{% url 'backOffice:edit_subscription' s.id %}">
                    <i class="bi bi-pencil-square me-1"></i>Edit
                  </a>

                  <form method="post" action="{% url 'backOffice:renew_subscription' s.id %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="days" value="30">
                    <button class="btn btn-sm btn-success" type="submit">
                      <i class="bi bi-arrow-repeat me-1"></i>Renew 30d
                    </button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">No subscribed agencies found.</div>
    {% endif %}
  </div>
</div>

{% endblock %}
